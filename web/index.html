
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPEC-001: PNPtv Live Bot</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 1em;
      line-height: 1.6;
      background: #fdfdfd;
      color: #222;
    }
    h1, h2, h3 {
      color: #007ACC;
    }
    pre {
      background: #f4f4f4;
      padding: 1em;
      overflow-x: auto;
      border-left: 4px solid #ccc;
    }
    img {
      max-width: 100%;
      margin: 1em 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5em;
    }
    th {
      background: #f0f0f0;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      td {
        border: none;
        border-bottom: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
<h1>SPEC-001: PNPtv Live Bot</h1>
<img src="architecture_diagram.png" alt="Arquitectura del sistema" />
<pre>= SPEC-001: Bot Unificado de Streaming Webex para PNPtv Live
:sectnums:
:toc:

== Background

PNPtv Live es una plataforma de entretenimiento que renta espacios virtuales a performers para transmitir en vivo a suscriptores. La necesidad surge de automatizar y profesionalizar la operaci√≥n de estos espacios, permitiendo:

- Automatizaci√≥n de interacciones con Webex (ingreso al lobby, encendido de c√°maras, mensajes autom√°ticos).
- Recepci√≥n de pagos tipo "tip" directamente al performer.
- Soporte para m√∫ltiples pasarelas de pago, incluyendo:
  - **PayPal** (internacional)
  - **Bold.co** (Colombia)
- Administraci√≥n centralizada de m√∫ltiples performers, suscriptores y shows.
- Integraci√≥n con interfaces de usuario: Webex + Panel Web.

El sistema existente estaba dividido en dos proyectos:
- Un bot b√°sico para automatizaci√≥n de reuniones Webex.
- Un bot avanzado con gesti√≥n de performers y tips.

Este dise√±o propone la **fusi√≥n de ambos sistemas** en una soluci√≥n unificada, escalable y reutilizable para otros negocios similares.

== Requirements

=== Funcionales

*Must Have*
- Automatizaci√≥n de reuniones Webex:
  - Admisi√≥n autom√°tica desde el lobby
  - Verificaci√≥n de c√°mara encendida
  - Env√≠o de mensajes programados
- Comandos por Webex para:
  - Ver estado del show (/status)
  - Enviar tip (/tip)
  - Suscribirse y desuscribirse (/join, /leave)
- Soporte multi-performer:
  - Registro, configuraci√≥n y activaci√≥n de performers
  - Estad√≠sticas individuales de cada show y tips
- Recepci√≥n de tips mediante:
  - PayPal
  - Bold.co
- Conversi√≥n autom√°tica COP/USD para PayPal.me
- Webhooks para procesar transacciones Bold en tiempo real
- Panel web con informaci√≥n del estado actual
- Administraci√≥n remota (v√≠a comandos o API) de:
  - Performers
  - Estad√≠sticas
  - Tips
- Mensajes directos personalizados a usuarios (seguimiento a tips)

*Should Have*
- Soporte para m√∫ltiples monedas (COP, USD)
- Panel administrativo embebido sin necesidad de frontend compilado
- Reportes diarios/semanales de actividad
- Control de acceso para comandos administrativos (/admin)

*Could Have*
- Integraci√≥n futura con Twitch o YouTube Live

*Won't Have*
- Streaming embebido (Webex se usa como plataforma externa)
- Gesti√≥n de pagos centralizada (cada performer recibe tips directo)

== Method

=== Arquitectura General

[plantuml, architecture, png]
----
@startuml
package "PNPtv Live Bot" {
  [Core Backend] --> [Webex API]
  [Core Backend] --> [PayPal API]
  [Core Backend] --> [Bold.co API]
  [Core Backend] --> [Webhook Processor]
  [Core Backend] --> [Panel Web (HTML)]
  [Core Backend] --> [Bot de Webex]
}

actor Performer
actor Viewer

Viewer --> [Webex Meeting]
Viewer --> [Bot de Webex]
Viewer --> [Panel Web (HTML)]

Performer --> [Core Backend]
@enduml
----

=== Modelo de Datos

==== Performer
[source,json]
----
{
  "id": "perf_17102025_ab12",
  "name": "Performer X",
  "email": "x@pnptvlive.com",
  "paypalEmail": "x@paypal.com",
  "boldId": "b1234567",
  "settings": {
    "currency": "COP",
    "tipMinAmount": 10000,
    "welcomeMessage": "¬°Bienvenido!",
    "tipMessage": "Gracias por tu apoyo"
  },
  "stats": {
    "totalTips": 0,
    "todayTips": 0,
    "averageTip": 0,
    "showCount": 0,
    "subscriberCount": 0
  },
  "subscribers": Set<string>,
  "tips": Tip[]
}
----

==== Tip
[source,json]
----
{
  "id": "tip_17102025_a1b2c3",
  "amount": 10000,
  "message": "¬°Gran show!",
  "user": "viewer@correo.com",
  "performer": "perf_17102025_ab12",
  "paymentMethod": "paypal",
  "paypalEmail": "x@paypal.com",
  "currency": "COP",
  "fees": {
    "gross": 10000,
    "fees": 500,
    "net": 9500
  },
  "status": "pending",
  "timestamp": ISODate,
  "processedAt": ISODate,
  "transactionId": string,
  "failureReason": string
}
----

==== Config Global
[source,json]
----
{
  "webhookSecret": "...",
  "masterPasswordHash": "...",
  "defaultCurrency": "COP",
  "exchangeRate": {
    "COP_USD": 4000
  }
}
----

=== Rutas API (REST)

[cols="1,3,1,2"]
|===
| M√©todo | Ruta | Autenticaci√≥n | Descripci√≥n

| GET    | /                         | -         | Renderiza el panel web principal (`index.html`)
| POST   | /webhook/bold             | HMAC      | Recibe pagos de Bold.co (confirma tips)
| POST   | /webhook/webex            | Token     | Recibe comandos desde Webex (mensajes)
| GET    | /admin/status             | password  | Resumen del sistema (m√©tricas, estado)
| GET    | /admin/performers         | password  | Lista de performers y stats b√°sicos
| GET    | /admin/tips               | password  | Lista de tips recientes
| POST   | /admin/switch-performer   | password  | Cambia performer activo para una sala
| POST   | /admin/reset-performer    | password  | Reinicia stats de un performer
| GET    | /api/tip/:id              | opcional  | Obtiene detalle de un tip por ID (usado por Web)
| GET    | /api/metrics              | -         | Devuelve m√©tricas agregadas (`metrics.json`)
| GET    | /api/sessions             | -         | Lista sesiones activas (`sessions.json`)
|===

=== Comandos Interactivos en index.html

==== Secciones del Panel Web

1. **Estado del sistema (Dashboard)**
   - Total de tips, shows activos, TRM actual
   - Lista de sesiones en vivo (desde `/api/sessions`)
   - Bot√≥n: üîÅ Actualizar m√©tricas (refresca panel con `/api/metrics`)

2. **Control del Performer**
   - Selector de performer activo
   - Bot√≥n: ‚ñ∂Ô∏è `Iniciar transmisi√≥n` ‚Üí llama `/admin/switch-performer`
   - Bot√≥n: üîÅ `Resetear stats` ‚Üí confirma y llama `/admin/reset-performer`

3. **Tips Recientes**
   - Lista en tiempo real de tips con:
     - usuario, monto, m√©todo, estado
   - Bot√≥n: üìã `Ver detalle` ‚Üí llama `/api/tip/:id`

4. **Comandos R√°pidos (desde navegador)**
   - Bot√≥n: üîÑ `/status` ‚Üí simula comando Webex
   - Bot√≥n: üí¨ `/tip` ‚Üí genera enlaces de pago para un monto r√°pido
   - Campos input: monto, mensaje (solo para prueba)

==== Seguridad
- Acciones protegidas con `masterPassword` v√≠a prompt o token temporal.
- Se puede cachear en `localStorage` con expiraci√≥n.

==== Estilo
- Solo HTML + JS (sin compiladores)
- Opcionalmente: Bootstrap o Tailwind v√≠a CDN
</pre>
</body>
</html>
